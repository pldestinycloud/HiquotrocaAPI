@page "/pedir"

<MudContainer MaxWidth="MaxWidth.Small" Class="pa-6"
              Style="background-color:white;border:none;box-shadow:none;border-radius:0;margin-top:15px;margin-bottom:50px;position:relative;">

    <!-- 🔙 Botão Voltar -->
    <img src="images/Arrow.png" alt="Voltar"
         @onclick="Voltar"
         style="position:absolute;top:10px;left:10px;width:24px;height:24px;cursor:pointer;" />

    <!-- Título -->
    <MudText Typo="Typo.h3" Align="Align.Center" Color="Color.Warning" Class="mb-4 mt-3">
        Novo Pedido
    </MudText>

    <!-- Upload de foto -->
    <MudPaper Elevation="0"
              Class="d-flex flex-column align-center justify-center pa-0"
              style="background-color:#dcdcdc;border-radius:10px;margin-bottom:25px;height:300px;position:relative;overflow:hidden;text-align:center;">
        @if (fotos.Count == 0)
        {
            <label for="uploadInput"
                   style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;margin:0;">
                <MudIcon Icon="@Icons.Material.Filled.Image" Size="Size.Large" Color="Color.Default" />
                <MudText Typo="Typo.subtitle1" Align="Align.Center" Class="mt-2" Style="color:#333;">
                    Carrega aqui a foto do teu pedido
                </MudText>
                <MudText Typo="Typo.caption" Align="Align.Center" Class="mt-3" Style="color:#333;font-weight:bold;">
                    NOTA: Tens direito a carregar apenas 1 foto por pedido.
                </MudText>
            </label>
        }
        else
        {
            @RenderCarousel()
        }

        <InputFile id="uploadInput"
                   OnChange="OnFotoSelecionada"
                   accept="image/*"
                   style="display:none;" />
    </MudPaper>

    <!-- Campos principais -->
    <MudTextField T="string" Label="Título do pedido" Variant="Variant.Outlined" FullWidth="true"
                  Placeholder="Título" @bind-Value="titulo" Required="true" />

    <MudSelect Label="Categoria" T="string" Variant="Variant.Outlined" FullWidth="true"
               Placeholder="Escolhe categoria" Required="true" Class="mt-4" @bind-Value="selectedCategoria">
        <MudSelectItem T="string">Eletrónica</MudSelectItem>
        <MudSelectItem T="string">Moda e Vestuário</MudSelectItem>
        <MudSelectItem T="string">Casa/Imóveis</MudSelectItem>
        <MudSelectItem T="string">Carros e Acessórios</MudSelectItem>
        <MudSelectItem T="string">Decoração e Mobiliário</MudSelectItem>
        <MudSelectItem T="string">Brinquedos e Hobbies</MudSelectItem>
        <MudSelectItem T="string">Material de Bricolage e DIY</MudSelectItem>
        <MudSelectItem T="string">Emprego</MudSelectItem>
        <MudSelectItem T="string">Diversos</MudSelectItem>
    </MudSelect>

    <MudTextField T="string" Label="Descrição" Variant="Variant.Outlined" FullWidth="true" Lines="4"
                  Placeholder="Escreve aqui uma descrição que explique da melhor forma possível o teu pedido"
                  Required="true" @bind-Value="descricao" Class="mt-4" />

    <MudTextField T="string" Label="Características (opcional)" Variant="Variant.Outlined" FullWidth="true" Lines="2"
                  Placeholder="Descreve aqui as características técnicas do teu pedido"
                  @bind-Value="caracteristicas" Class="mt-4" />

    <MudTextField T="string" Label="Elementos (opcional)" Variant="Variant.Outlined" FullWidth="true" Lines="2"
                  Placeholder="Coloca aqui todos os elementos incluídos no pedido"
                  @bind-Value="elementos" Class="mt-4" />

    <MudTextField T="string" Label="Localização" Variant="Variant.Outlined" FullWidth="true"
                  Placeholder="Localização" @bind-Value="localizacao" Required="true" Class="mt-4" />

    <MudSelect Label="Recolha" T="string" Variant="Variant.Outlined" FullWidth="true"
               Placeholder="Disponibilidade" @bind-Value="selectedRecolha" Class="mt-4" Required="true">
        <MudSelectItem T="string">Posso levantar</MudSelectItem>
        <MudSelectItem T="string">Preciso de entrega</MudSelectItem>
    </MudSelect>

    <MudButton Variant="Variant.Filled" Color="Color.Warning" FullWidth="true"
               Class="mt-6 py-2" Style="text-transform:none;font-weight:bold;border-radius:10px;"
               OnClick="PublicarPedido">
        Publicar
    </MudButton>
</MudContainer>

<Footer />

@code {
    [Inject] NavigationManager Nav { get; set; } = default!;

    private string titulo = "";
    private string selectedCategoria = "";
    private string descricao = "";
    private string caracteristicas = "";
    private string elementos = "";
    private string localizacao = "";
    private string selectedRecolha = "";

    private List<string> fotos = new();
    private int currentIndex = 0;

    private void Voltar() => Nav.NavigateTo("/addpost");

    private async Task OnFotoSelecionada(InputFileChangeEventArgs e)
    {
        if (e == null) return;

        var file = e.File;
        using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
        var buffer = new byte[file.Size];
        await stream.ReadAsync(buffer);
        var imageData = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
        fotos.Clear();
        fotos.Add(imageData);
    }

    private void PublicarPedido()
    {
        Console.WriteLine($"Pedido publicado: {titulo}, {selectedCategoria}, {descricao}, {localizacao}");
        Nav.NavigateTo("/addpost");
    }

    private RenderFragment RenderCarousel() => __builder =>
    {
        __builder.OpenComponent<MudCarousel<string>>(0);
        __builder.AddAttribute(1, "Style", "width:100%;height:100%;");
        __builder.AddAttribute(2, "AutoCycle", false);
        __builder.AddAttribute(3, "ShowArrows", false);
        __builder.AddAttribute(4, "ShowIndicators", true);
        __builder.AddAttribute(5, "ChildContent", (RenderFragment)((builder2) =>
        {
            int seq = 0;
            foreach (var foto in fotos)
            {
                builder2.OpenComponent<MudCarouselItem>(seq++);
                builder2.AddAttribute(seq++, "ChildContent", (RenderFragment)((builder3) =>
                {
                    builder3.AddMarkupContent(seq++, $"<img src='{foto}' style='width:100%;height:100%;object-fit:cover;' />");
                }));
                builder2.CloseComponent();
            }
        }));
        __builder.CloseComponent();
    };
}

<style>
    .mud-input, .mud-select {
        border-radius: 10px !important;
    }

    .mud-container {
        background-color: #ffffff;
    }

    .mud-input-label {
        font-weight: 500;
        color: #333 !important;
    }

    .mud-input-input, .mud-select-input {
        font-size: 0.95rem;
    }

    .mud-carousel-indicators {
        bottom: 10px !important;
    }
</style>
