@page "/start"
@using Hiquotroca.Dtos
@inject Hiquotroca.Services.AuthApiService AuthService
@inject NavigationManager Nav

<MudContainer MaxWidth="MaxWidth.False"
              Class="pa-0"
              Style="width:100%;height:100vh;overflow:hidden;padding:0;margin:0;position:relative;background:white;">

    <!-- SPLASH SCREEN -->
    @if (!ShowSignUp)
    {
        <div class="@($"splash-screen {SplashClass}")"
             @onclick="GoToSignUp"
             style="width:100%;height:100%;position:absolute;inset:0;cursor:pointer;">
            <img src="images/SplashFoto.jpg"
                 style="width:100%;height:100%;object-fit:cover;object-position:center 30%;" />
        </div>
    }

    <!-- SIGN UP SCREEN -->
    @if (ShowSignUp)
    {
        <div class="@($"signup-screen {SignUpClass}")"
             style="width:100%;height:100%;background:white;position:absolute;inset:0;
                        padding:32px;overflow-y:auto;">

            <div style="display:flex;justify-content:center;margin-top:15px;">
                <MudImage Src="images/Fox.png" Style="width:110px;" />
            </div>

            <MudText Typo="Typo.h4"
                     Align="Align.Center"
                     Color="Color.Warning"
                     Style="font-weight:bold;margin-top:18px;margin-bottom:25px;">
                Sign Up
            </MudText>

            <div style="display:flex; gap:12px; margin-bottom:25px; margin-top:-10px;">
                <MudPaper Elevation="0"
                          Style="flex:1;padding:12px;background:#f1f6ff;border-radius:14px;
                                     display:flex;align-items:center;gap:10px;cursor:pointer;">
                    <MudIcon Icon="@Icons.Custom.Brands.Facebook" Color="Color.Primary" />
                    <MudText Typo="Typo.body1" Style="font-weight:600;">Facebook</MudText>
                </MudPaper>

                <MudPaper Elevation="0"
                          Style="flex:1;padding:12px;background:#f1f6ff;border-radius:14px;
                                     display:flex;align-items:center;gap:10px;cursor:pointer;">
                    <MudIcon Icon="@Icons.Custom.Brands.Google" Color="Color.Error" />
                    <MudText Typo="Typo.body1" Style="font-weight:600;">Google</MudText>
                </MudPaper>
            </div>

            <div style="display:flex;align-items:center;justify-content:center;margin:10px 0 20px 0;">
                <div style="flex:1;height:1px;background:#ddd;"></div>
                <MudText Typo="Typo.body2" Style="margin:0 10px;color:#666;">Ou</MudText>
                <div style="flex:1;height:1px;background:#ddd;"></div>
            </div>

            <!-- INPUTS -->
            <MudTextField @bind-Value="model.Nome"
                          Label="Nome"
                          Placeholder="Nome"
                          Variant="Variant.Outlined"
                          Class="campo mb-3" />

            <MudTextField @bind-Value="model.Email"
                          Label="Email/Telemóvel"
                          Placeholder="Email / Telemóvel"
                          Variant="Variant.Outlined"
                          Class="campo mb-3" />

            <MudTextField @bind-Value="model.Password"
                          Label="Palavra passe"
                          InputType="InputType.Password"
                          Placeholder="********"
                          Variant="Variant.Outlined"
                          Class="campo mb-4" />

            <!-- CHECKBOX CORRIGIDA -->
            <MudCheckBox T="bool?"
                         @ref="termosCheckbox"
                         Label="Concordo com os Termos de Serviço e a Política de Privacidade"
                         Color="Color.Warning"
                         Style="font-size:14px;margin-bottom:12px;" />

            <MudButton Variant="Variant.Filled"
                       Color="Color.Warning"
                       FullWidth="true"
                       Disabled="isLoading"
                       OnClick="CriarConta"
                       Style="text-transform:none;font-weight:bold;border-radius:10px;padding:12px;">
                @(isLoading ? "A criar..." : "Criar Conta")
            </MudButton>

            @if (!string.IsNullOrEmpty(message))
            {
                <MudText Color="Color.Error" Style="margin-top:10px;">
                    @message
                </MudText>
            }

            <MudText Typo="Typo.body2"
                     Align="Align.Left"
                     Style="margin-top:22px; font-size:15px; color:#555;">
                Já tem conta?
                <MudLink @onclick="IrParaLogin"
                         Style="font-size:15px;color:#1a73e8 !important;font-weight:400;cursor:pointer;margin-left:4px;">
                    Inicie sessão
                </MudLink>
            </MudText>

        </div>
    }
</MudContainer>


<style>
    .fadeout {
        animation: splashFadeOut .45s forwards ease-out;
    }

    @@keyframes splashFadeOut {
        to {
            opacity: 0;
            transform: scale(1.05);
        }
    }

    .fadein {
        animation: signUpFadeIn .45s forwards ease-out;
    }

    @@keyframes signUpFadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .campo .mud-input-root {
        background: #edf4ff !important;
        border-radius: 12px !important;
    }

    .campo input {
        background: transparent !important;
    }
</style>

@code {
    bool ShowSignUp = false;
    string SplashClass = "";
    string SignUpClass = "";

    RegisterRequest model = new();
    bool isLoading = false;
    string? message = null;

    // REFERÊNCIA PARA A CHECKBOX
    MudCheckBox<bool?>? termosCheckbox;

    async Task GoToSignUp()
    {
        SplashClass = "fadeout";
        StateHasChanged();
        await Task.Delay(450);

        ShowSignUp = true;
        SignUpClass = "fadein";
    }

    void IrParaLogin()
    {
        Nav.NavigateTo("/login1");
    }

    async Task CriarConta()
    {
        message = null;

        var aceitouTermos = termosCheckbox?.Value ?? false;


        if (!aceitouTermos)
        {
            message = "Tem de aceitar os Termos de Serviço e a Política de Privacidade.";
            return;
        }

        isLoading = true;

        var (ok, msg) = await AuthService.RegisterAsync(model);

        isLoading = false;
        message = msg;

        if (ok)
        {
            Nav.NavigateTo("/login1", forceLoad: true);
        }
    }
}
